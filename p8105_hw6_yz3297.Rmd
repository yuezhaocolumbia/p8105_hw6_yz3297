---
title: "p8105_hw6_yz3297"
author: "Yue Zhao"
date: "2018年11月23日"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

##Problem 1

```{r,message = FALSE,warning=FALSE}
homicide_data= read_csv(file="./data/homicide-data.csv") %>%
   mutate(city_state=paste(city,state,sep=", ")) %>%
   mutate(solved= ifelse(disposition=="Closed by arrest","solved","unsolved")) %>% 
   filter(city_state != "Dallas, TX" & city_state != "Phoenix, AZ" & city_state !="Kansas City, MO" & city_state !="Tulsa, AL") %>% 
   mutate(victim_race= ifelse(victim_race=="White","white","non-white")) %>% 
   mutate(victim_age=as.numeric(victim_age),victim_race = fct_relevel(victim_race, "white"))
  
```


####I first created city_state and then deleted the entries that was not useful. And then I changed the race variable to be binary and set the reference group as white. 


```{r}

fit_logistic = 
  homicide_data %>% 
  filter(city_state=="Baltimore, MD") %>% 
  mutate(solved=as.numeric(disposition == "Closed by arrest")) %>% 
  glm(solved ~ victim_age + victim_sex + victim_race , data = ., family = binomial()) %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),CILOW=exp(estimate-std.error),CIUP=exp(estimate+std.error)) %>% 
  filter(term=="victim_racenon-white") %>% 
  select(OR,CILOW,CIUP)

fit_logistic %>% 
   knitr::kable(digits=3) 

```

####This code chunk was to calculate the OR of solving the case comparing non white to white victims. I used a logistic regression for the data in Baltimore, MD. I first changed the "solved" as a 0,1, then I used gm function. Then I only reserved the race OR and calculated the 95% CI. The OR and 95% CI for Baltimore was presented in the table. 

```{r}

final_OR= 
  homicide_data %>% 
  mutate(solved=as.numeric(disposition == "Closed by arrest")) %>% 
  select(city_state,solved,victim_age,victim_sex,victim_race) 

orfunc1= function(x) {
  glm(solved ~ victim_age + victim_sex + victim_race , data = x, family = binomial()) %>% 
  broom::tidy() %>% 
  filter(term=="victim_racenon-white")
}

```

####The final_OR dataset is to create a clean dataset that only includes the data we need for the OR calculation. Then I define a function to do the logistic regression and get the beta estimate and standard error terms.These are prepared to be used in the mapping step coming up next. 


```{r}

final_OR2 = 
  final_OR %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(map2= map(data, orfunc1)) %>%
  select(city_state,map2) %>% 
  unnest() %>% 
  mutate(OR = exp(estimate),CILOW=exp(estimate-std.error),CIUP=exp(estimate+std.error)) %>% 
  select(city_state,OR,CILOW,CIUP)
  
```

####Then I nested the regression variables and mapped the dataset to a dataset with city_state, data, map2. Then I dropped data and unnest the dataset. I mutated to create a the OR and confidence interval estimate. Finally, I dropped other variables. 


```{r}

final_OR2 %>% 
  mutate(city_state = fct_reorder(city_state,OR,.desc=TRUE)) %>%
  ggplot(aes(x = city_state, y = OR)) +
        geom_point() +
        labs(title = "OR and 95%CI by Cities",
             x = "City",
             y = "OR and 95%CI",
             Caption = "OR and 95%CI by Cities") +
        geom_errorbar(aes(ymin = CILOW, ymax = CIUP)) +
        coord_flip()
```

####I plotted the OR and 95% CI by each city. The plot shows most of the cities have an OR less than 1, which means the cases with a non white victim are less likely to get solved. This shows the same conclusion in the article. 
